// Pathway Framework Integration for Real-time File Monitoring
// This service would integrate with Pathway for real-time monitoring of PDF reports

interface PathwayConfig {
  reportFolderPath: string;
  filePattern: string;
  pollingInterval: number;
}

interface ReportData {
  id: string;
  fileName: string;
  filePath: string;
  lastModified: Date;
  content: any;
}

export class PathwayMonitoringService {
  private config: PathwayConfig;
  private reports: Map<string, ReportData> = new Map();
  private subscribers: ((data: ReportData[]) => void)[] = [];

  constructor(config: PathwayConfig) {
    this.config = config;
  }

  // Initialize Pathway monitoring
  async initialize() {
    // In a real implementation, this would:
    // 1. Set up Pathway input connector for file system monitoring
    // 2. Configure PDF parsing pipeline
    // 3. Set up real-time data processing
    
    console.log('Initializing Pathway monitoring for:', this.config.reportFolderPath);
    
    // Simulate initial scan
    await this.scanReportsFolder();
    
    // Set up periodic monitoring (in real implementation, this would be event-driven)
    setInterval(() => {
      this.scanReportsFolder();
    }, this.config.pollingInterval);
  }

  // Scan reports folder for new/updated PDF files
  private async scanReportsFolder() {
    try {
      // Read monitoring data from JSON file generated by Python script
      const monitoringData = await this.readMonitoringData();
      
      // Clear existing reports
      this.reports.clear();
      
      // Update reports map with actual data
      monitoringData.forEach(report => {
        this.reports.set(report.id, report);
      });
      
      // Notify subscribers
      this.notifySubscribers();
      
    } catch (error) {
      console.error('Error scanning reports folder:', error);
    }
  }

  // Read monitoring data from JSON file
  private async readMonitoringData(): Promise<ReportData[]> {
    try {
      // Try to read from the monitoring data file generated by Python script
      const response = await fetch('/monitoring_data.json?t=' + Date.now());
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      const data = await response.json();
      console.log('Monitoring data loaded:', data);
      
      if (!data.reports || !Array.isArray(data.reports)) {
        console.log('No reports array found in monitoring data');
        return [];
      }
      
      return data.reports.map((report: any) => ({
        id: report.id || report.filename?.replace('.pdf', '') || Math.random().toString(),
        fileName: report.filename || 'unknown.pdf',
        filePath: report.file_path || '',
        lastModified: new Date(report.last_modified || report.timestamp || Date.now()),
        content: {
          observerName: report.observer_name || 'Unknown',
          species: report.species || 'Unknown Species',
          city: report.city || 'Unknown City',
          location: report.location || 'Unknown Location',
          date: report.date || '',
          time: report.time || '',
          urgencyLevel: report.urgency_level || 'Low',
          weather: report.weather || '',
          animalBehavior: report.animal_behavior || '',
          description: report.description || ''
        }
      }));
    } catch (error) {
      console.log('No monitoring data file found yet. Make sure Python script is running and PDF reports are in src/reports folder');
      return [];
    }
  }

  // Subscribe to real-time updates
  subscribe(callback: (data: ReportData[]) => void) {
    this.subscribers.push(callback);
    
    // Immediately send current data
    callback(Array.from(this.reports.values()));
    
    return () => {
      this.subscribers = this.subscribers.filter(sub => sub !== callback);
    };
  }

  // Get all current reports
  getAllReports(): ReportData[] {
    return Array.from(this.reports.values());
  }

  // Get reports by criteria
  getReportsBySpecies(species: string): ReportData[] {
    return this.getAllReports().filter(report => 
      report.content?.species?.toLowerCase().includes(species.toLowerCase())
    );
  }

  getReportsByUrgency(urgencyLevel: string): ReportData[] {
    return this.getAllReports().filter(report => 
      report.content?.urgencyLevel?.toLowerCase() === urgencyLevel.toLowerCase()
    );
  }

  // Notify all subscribers
  private notifySubscribers() {
    const reports = Array.from(this.reports.values());
    this.subscribers.forEach(callback => callback(reports));
  }

}

// Create and export singleton instance
export const pathwayMonitor = new PathwayMonitoringService({
  reportFolderPath: './src/reports',
  filePattern: '*.pdf',
  pollingInterval: 5000 // 5 seconds for faster updates
});

// For Windows deployment, additional configuration would be needed:
export const windowsPathwayConfig = {
  // Pathway installation on Windows
  installCommand: 'pip install pathway',
  
  // Windows-specific file monitoring
  watchFolder: 'C:\\WildlifeReports',
  
  // PowerShell integration for file operations
  psCommands: {
    listFiles: 'Get-ChildItem -Path "C:\\WildlifeReports" -Filter "*.pdf"',
    watchChanges: 'Get-WinEvent -FilterHashtable @{LogName="System"; ID=4656}'
  },
  
  // Docker setup for Windows
  dockerSetup: {
    dockerfile: `
FROM python:3.11-slim
RUN pip install pathway pandas
WORKDIR /app
COPY . .
CMD ["python", "pathway_monitor.py"]
`,
    composeFile: `
version: '3.8'
services:
  pathway-monitor:
    build: .
    volumes:
      - C:\\WildlifeReports:/app/reports
    environment:
      - REPORTS_PATH=/app/reports
`
  }
};